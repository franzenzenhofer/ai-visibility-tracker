<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Visibility Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; padding: 2rem; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #333; margin-bottom: 0.5rem; }
    .subtitle { color: #666; margin-bottom: 2rem; }
    .card { background: white; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 1rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
    input, select { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    button { padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #545b62; }
    #fileInput { padding: 0.5rem 0; }
    .progress { margin: 1rem 0; }
    .progress-bar { height: 20px; background: #ddd; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: #28a745; transition: width 0.3s; }
    #results { margin-top: 2rem; }
    .result-item { padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #007bff; background: #f8f9fa; }
    .status-visible { border-left-color: #28a745; }
    .status-invisible { border-left-color: #dc3545; }
    .status-tool-only { border-left-color: #ffc107; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç AI Visibility Tracker</h1>
    <p class="subtitle">Track your domain visibility across GPT & Gemini</p>

    <div class="card">
      <h2>Upload File</h2>
      <div class="form-group">
        <label for="fileInput">GSC Export (Excel/CSV)</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
      </div>
    </div>

    <div class="card">
      <h2>API Keys (BYOK - Bring Your Own Keys)</h2>
      <div class="form-group">
        <label for="openaiKey">OpenAI API Key</label>
        <input type="password" id="openaiKey" placeholder="sk-proj-...">
      </div>
      <div class="form-group">
        <label for="geminiKey">Google Gemini API Key</label>
        <input type="password" id="geminiKey" placeholder="AIza...">
      </div>
      <button onclick="saveKeys()">üíæ Save Keys (localStorage)</button>
    </div>

    <div class="card">
      <h2>Configuration</h2>
      <button onclick="autoDetect()" id="detectBtn" disabled>ü§ñ Auto-Detect Config</button>
      <div class="form-group">
        <label for="targetDomain">Target Domain</label>
        <input type="text" id="targetDomain" placeholder="example.com">
      </div>
      <div class="form-group">
        <label for="userLocation">User Location</label>
        <input type="text" id="userLocation" placeholder="Vienna, Austria">
      </div>
      <div class="form-group">
        <label for="queryLimit">Query Limit</label>
        <select id="queryLimit">
          <option value="3">3 queries (recommended)</option>
          <option value="10">10 queries</option>
        </select>
      </div>
    </div>

    <div class="card">
      <button onclick="startProcessing()" id="startBtn" disabled>‚ñ∂Ô∏è Start Processing</button>
      <div id="progressSection" class="progress hidden">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText">Processing...</p>
      </div>
    </div>

    <div id="results"></div>
  </div>

  <script>
    let uploadedFile = null;
    let eventSource = null;

    // Load saved keys
    document.addEventListener('DOMContentLoaded', () => {
      const openai = localStorage.getItem('openaiKey');
      const gemini = localStorage.getItem('geminiKey');
      if (openai) document.getElementById('openaiKey').value = openai;
      if (gemini) document.getElementById('geminiKey').value = gemini;
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      uploadedFile = e.target.files[0];
      document.getElementById('detectBtn').disabled = !uploadedFile;
      document.getElementById('startBtn').disabled = !uploadedFile;
    });

    function saveKeys() {
      const openai = document.getElementById('openaiKey').value;
      const gemini = document.getElementById('geminiKey').value;
      localStorage.setItem('openaiKey', openai);
      localStorage.setItem('geminiKey', gemini);
      alert('Keys saved to localStorage!');
    }

    async function autoDetect() {
      const formData = new FormData();
      formData.append('file', uploadedFile);
      formData.append('openaiApiKey', document.getElementById('openaiKey').value);

      const res = await fetch('/api/detect', { method: 'POST', body: formData });
      const data = await res.json();

      if (data.success) {
        document.getElementById('targetDomain').value = data.detected.targetDomain;
        document.getElementById('userLocation').value = data.detected.userLocation;
        alert('Auto-detection complete!');
      } else {
        alert('Error: ' + data.error);
      }
    }

    function startProcessing() {
      const formData = new FormData();
      formData.append('file', uploadedFile);
      formData.append('openaiApiKey', document.getElementById('openaiKey').value);
      formData.append('geminiApiKey', document.getElementById('geminiKey').value);
      formData.append('targetDomain', document.getElementById('targetDomain').value);
      formData.append('userLocation', document.getElementById('userLocation').value);
      formData.append('queryLimit', document.getElementById('queryLimit').value);

      document.getElementById('progressSection').classList.remove('hidden');
      document.getElementById('startBtn').disabled = true;
      document.getElementById('results').innerHTML = '';

      eventSource = new EventSource('/api/process?' + new URLSearchParams(
        Array.from(formData.entries()).map(([k, v]) => [k, typeof v === 'string' ? v : ''])
      ));

      eventSource.onmessage = (e) => {
        const event = JSON.parse(e.data);

        if (event.type === 'progress') {
          const pct = (event.data.current / event.data.total) * 100;
          document.getElementById('progressFill').style.width = pct + '%';
          document.getElementById('progressText').textContent =
            `Processing ${event.data.current}/${event.data.total}...`;
        }

        if (event.type === 'query_complete') {
          const result = event.data;
          const resultHtml = `
            <div class="result-item status-${result.status}">
              <strong>${result.originalQuery}</strong>
              <p>Status: ${result.status.toUpperCase()}</p>
              <p>GPT: Rank ${result.gptRank} | Gemini: Rank ${result.gemRank}</p>
            </div>
          `;
          document.getElementById('results').insertAdjacentHTML('beforeend', resultHtml);
        }

        if (event.type === 'complete') {
          document.getElementById('startBtn').disabled = false;
          document.getElementById('progressText').textContent = 'Complete!';
          eventSource.close();
        }
      };
    }
  </script>
</body>
</html>
